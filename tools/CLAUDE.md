<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>

# TextBridge Tools

Keychron B6 Pro (nRF52840) 펌웨어 빌드, 플래시, 테스트 도구 모음.

## 의존성

```bash
pip install hidapi bleak
```

- `hidapi`: USB Raw HID 통신 (enter_dfu.py, tb_pair.py)
- `bleak`: BLE GATT 통신 (모든 테스트 스크립트)

모든 BLE 테스트 스크립트에 VIA 페어링(0xFE)이 내장되어 있다.

## 빌드

```bash
source ~/.zmk_env/bin/activate && \
export ZEPHYR_SDK_INSTALL_DIR=~/.zephyr-sdk-0.16.3 && \
cd ~/project/textbridge/zmk_keychron/app && \
west build --pristine -b keychron -- -DSHIELD=keychron_b6_us
```

출력: `build/zephyr/zmk.uf2` (FLASH 25%, SRAM 33%)

`--pristine` 생략하면 증분 빌드 (변경 파일만 재컴파일).

## DFU 진입 + 플래시

```bash
python3 enter_dfu.py && sleep 3 && cp ~/project/textbridge/zmk_keychron/app/build/zephyr/zmk.uf2 /Volumes/NRF52BOOT/
```

수동 DFU: 키보드 ESC 누른 채 USB 연결.

## 텍스트 전송 (test_phase3_protocol.py)

VIA 페어링 → BLE 스캔 → 연결 → 키코드 전송 → Enter. 모두 자동. macOS(Ctrl+Space 토글) 고정.

```bash
python3 test_phase3_protocol.py --text "hello"
python3 test_phase3_protocol.py --text "Hello 안녕 World"
```

출력:

```
pairing... ok
scanning... 7B2890F5-B71F-CC2C-0CC1-C9A378436B0B
sending... ok
```

## 한글 전송 테스트 (test_phase5_hangul.py)

사전 정의된 한글 테스트 케이스를 순서대로 전송. 각 텍스트마다 Enter 포함.

```bash
python3 test_phase5_hangul.py --test pure        # 순수 한글 (안녕하세요, 대한민국, 프로그래밍)
python3 test_phase5_hangul.py --test mixed       # 한영 혼합
python3 test_phase5_hangul.py --test complex     # 쌍자음/겹받침 (까닭없이, 왕관, 값싼, 읽다, 앉다)
python3 test_phase5_hangul.py --test all         # 전체
```

출력:

```
pairing... ok
scanning... 7B2890F5-B71F-CC2C-0CC1-C9A378436B0B
안녕하세요... ok
대한민국... ok
```

## Dart-Python 키코드 비교 (test_app_bridge.py)

```bash
python3 test_app_bridge.py --compare all         # 오프라인 비교 (BLE 불필요, 12/12 MATCH)
python3 test_app_bridge.py --test all            # BLE 전송 테스트 (macOS에서: Windows+한글 케이스 자동 제외, 6/6)
```

`--test all`은 macOS에서 실행 시 Windows 토글(LANG1)이 필요한 한글 케이스를 자동 제외한다. ASCII 3개 + macOS 한글 3개 = 6개만 BLE로 전송.

## 기타 도구

| 도구 | 설명 |
|------|------|
| `enter_dfu.py` | VIA Raw HID로 DFU 부트로더 진입 |
| `tb_pair.py` | VIA Raw HID로 BLE 광고 시작 (디버깅용) |
| `test_phase2_ble.py` | BLE GATT 연결/서비스/특성 테스트 |

## HID 출력 검증 방법 (Claude Code 터미널 활용)

### 개요

키보드 펌웨어가 USB HID로 주입하는 텍스트가 올바른지 검증하는 방법.
pynput(macOS Accessibility 권한 필요)이나 clipboard 조작 없이, **Claude Code 자체를 검증기**로 사용한다.

### 동작 원리

TextBridge 키보드는 USB HID 키보드다. 키코드를 주입하면 macOS가 **현재 커서 포커스가 있는 앱**에 키 입력을 전달한다.

```
Python 스크립트 →(BLE)→ 키보드 펌웨어 →(USB HID)→ macOS →(키 입력)→ 포커스된 앱
```

사용자가 **Claude Code 터미널 입력창에 커서를 둔 상태**로 테스트를 실행하면,
HID 주입된 문자들이 Claude Code 입력창에 타이핑된다.
텍스트 끝에 **Enter 키코드(HID 0x28)**를 보내면, Claude Code에 **사용자 메시지로 제출**된다.

### Claude Code가 수행할 검증 절차

1. **예상 텍스트를 기억한다** — Python 스크립트가 보낼 텍스트를 미리 알고 있어야 한다
2. **Python 스크립트를 백그라운드로 실행한다** — Bash 도구의 `run_in_background` 사용
   ```bash
   # 단일 텍스트 검증
   python3 test_phase3_protocol.py --text "hello"
   # 한글 그룹 검증
   python3 test_phase5_hangul.py --test pure
   ```
   - 모든 스크립트는 텍스트 끝에 Enter(0x28)를 자동 추가한다
3. **다음 사용자 메시지를 기다린다** — HID 주입이 완료되면 Enter에 의해 자동 제출된다
   - 이 메시지의 내용이 곧 키보드가 실제로 출력한 텍스트이다
4. **수신한 메시지 vs 예상 텍스트를 비교한다** — 일치하면 PASS, 불일치면 FAIL + diff 출력

### 전제 조건

- **macOS 입력 소스가 영문(ABC)** 상태에서 시작해야 한다. 모든 테스트는 시스템 초기 입력이 영어라고 가정한다.
- 한글 텍스트가 시작되면 `hangul_to_keycodes`가 자동으로 Ctrl+Space 토글키를 삽입하여 한글 입력으로 전환한다.
- `hangul_to_keycodes`는 텍스트 끝이 한글이면 자동으로 trailing toggle을 추가하여 영문으로 복귀한다. 따라서 매 전송 후 시스템은 영문 상태로 돌아온다.
- 참고: Dart 앱의 `textToKeycodes`는 trailing toggle을 포함하지 않는다 (`endsInKorean` 플래그로 별도 처리). `test_app_bridge.py`는 Dart 키코드 사용 시 `ends_in_korean` 플래그를 확인하여 별도 세션으로 trailing toggle을 전송한다.
- 사용자가 Claude Code 터미널 입력창에 커서 포커스를 유지해야 한다
- 테스트 도중 사용자가 직접 타이핑하면 검증이 깨진다

## 주의사항

- **macOS BLE GATT 캐시**: 펌웨어 리플래시 또는 비정상 BLE 해제 후 macOS가 CCC 상태를 캐싱하여 `tb_notify_enabled`가 false로 남을 수 있음. 해결: macOS Bluetooth 끄고 켜기.
- **키보드 전원 리셋**: 배터리가 있어 USB 재연결만으론 펌웨어 상태가 초기화되지 않음. 뒷면 전원 스위치 OFF → 5초 → ON.
- **실행 디렉터리**: 모든 스크립트는 `tools/` 디렉터리에서 실행. `cd tools && python3 <script>.py`
- **macOS Carbon API 제한**: `TISCopyCurrentKeyboardInputSource()`는 호출 프로세스의 입력 소스를 반환한다. 백그라운드 Python에서 호출하면 포커스된 앱(Claude Code)의 입력 소스가 아닌 Python 프로세스의 입력 소스(항상 ABC)가 반환된다. 입력 소스 감지에 사용 불가.

## 시리얼 로그

```bash
screen /dev/tty.usbmodem* 115200
```
