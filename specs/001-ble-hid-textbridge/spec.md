# 기능 명세: TextBridge BLE-to-USB HID 텍스트 브릿지

**Feature Branch**: `001-ble-hid-textbridge`
**Created**: 2026-02-08
**Status**: Draft
**Input**: 폐쇄망 회사 PC에 휴대폰에서 프로그래밍 소스 코드를 전송하는 시스템.
Keychron B6 Pro 키보드(nRF52840)를 BLE-to-USB HID 브릿지로 활용.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 영문/ASCII 텍스트 전송 (Priority: P1)

사용자는 휴대폰에서 영문 프로그래밍 소스 코드를 입력(또는 붙여넣기)한 뒤,
USB로 연결된 회사 PC의 활성 창에 텍스트가 자동으로 타이핑되도록 전송한다.

키보드는 USB로 PC에 연결되어 있으며, 휴대폰은 BLE로 키보드와 연결된다.
사용자가 앱에서 "전송"을 누르면, 텍스트가 키코드로 변환되어 키보드를 통해
PC에 HID 키 입력으로 전달된다.

**Why this priority**: 프로젝트의 핵심 가치 — 폐쇄망 PC에 텍스트를 전달하는
유일한 경로. ASCII만으로도 대부분의 프로그래밍 언어(Python, JS, C 등)
소스 코드를 전송할 수 있다.

**Independent Test**: 휴대폰 앱에서 `print("hello world")`를 입력하고 전송
버튼을 누르면, PC의 텍스트 편집기에 동일한 문자열이 자동 타이핑된다.

**Acceptance Scenarios**:

1. **Given** 키보드가 USB로 PC에 연결되고 폰이 BLE로 키보드에 연결된 상태,
   **When** 사용자가 앱에서 `console.log("test");`를 입력하고 전송을 누르면,
   **Then** PC의 활성 창에 `console.log("test");`가 순서대로 타이핑된다.
2. **Given** BLE 연결이 완료된 상태,
   **When** 사용자가 500자의 영문 소스 코드를 붙여넣기하고 전송하면,
   **Then** 전체 텍스트가 진행률 표시와 함께 정확하게 전송되고,
   완료 후 "전송 완료" 알림이 표시된다.
3. **Given** 전송이 진행 중인 상태,
   **When** 사용자가 "중지" 버튼을 누르면,
   **Then** 전송이 즉시 중단되고 PC에는 중단 시점까지의 텍스트만 남으며,
   키보드는 정상 상태로 복귀한다.

---

### User Story 2 - BLE 페어링 및 연결 관리 (Priority: P2)

사용자는 최초 1회 물리적 키 조작으로 키보드와 휴대폰을 페어링한다.
이후에는 키보드를 USB로 PC에 연결하면 자동으로 BLE 광고가 시작되고,
앱에서 한 번 탭하면 연결된다.

연결 상태는 앱에서 실시간으로 확인할 수 있으며, 연결이 끊어지면 즉시
알림을 받는다.

**Why this priority**: 텍스트 전송의 전제 조건. 안정적인 BLE 연결 없이는
텍스트 전송이 불가능하다. 보안 요구사항(본딩, 암호화)도 이 단계에서 충족해야
한다.

**Independent Test**: 키보드에서 Fn+1을 3초 이상 누르면 앱의 스캔 화면에
"B6 TextBridge"가 나타나고, 탭하면 "연결됨" 상태로 전환된다.

**Acceptance Scenarios**:

1. **Given** 키보드가 USB로 연결되어 있고 아직 페어링된 적 없는 상태,
   **When** 사용자가 키보드에서 Fn+1을 3초 이상 누르면,
   **Then** 앱의 BLE 스캔 목록에 "B6 TextBridge" 장치가 나타난다.
2. **Given** 앱 스캔 목록에 "B6 TextBridge"가 표시된 상태,
   **When** 사용자가 해당 장치를 탭하면,
   **Then** BLE 본딩이 수행되고 앱에 "연결됨" 상태가 표시된다.
3. **Given** 이미 본딩된 폰과 키보드가 있고 키보드를 USB로 PC에 연결한 상태,
   **When** 앱을 열고 장치를 선택하면,
   **Then** 별도의 페어링 절차 없이 즉시 연결된다.
4. **Given** BLE 연결이 활성화된 상태에서 키보드의 USB 케이블을 뽑으면,
   **When** BLE 연결이 끊어지면,
   **Then** 앱에 "연결 끊김" 상태가 즉시 표시되고, 진행 중이던 전송이
   있었다면 중단되며 키보드는 정상 상태로 복귀한다.

---

### User Story 3 - 한글 텍스트 전송 (Priority: P3)

사용자는 한글이 포함된 텍스트를 전송한다. 앱이 한글 음절을 자동으로
자모(초성/중성/종성)로 분해하고, 두벌식 키보드 배열에 맞는 키코드로 변환하여
전송한다. PC에서는 한글 IME를 통해 원래 한글 텍스트가 그대로 재현된다.

한글과 영문이 혼합된 텍스트도 지원하며, 앱이 한/영 전환키를 자동으로
삽입한다.

**Why this priority**: 폐쇄망 PC에서 한글 문서 작업이 필요한 경우에 대응.
영문 소스 코드만으로는 주석, 문서, 한글 변수명 등을 전송할 수 없다.

**Independent Test**: 앱에서 `// 안녕하세요 테스트`를 입력하고 전송하면,
PC의 텍스트 편집기에 동일한 한글+영문 혼합 텍스트가 정확히 타이핑된다.

**Acceptance Scenarios**:

1. **Given** BLE 연결 상태이고 대상 OS가 Windows로 설정된 상태,
   **When** 사용자가 `가나다`를 전송하면,
   **Then** PC에서 한영키(0x90)가 자동 입력된 후 `가나다`가 두벌식 키입력으로
   재현되고, 전송 후 한영키가 다시 눌려 영문 모드로 복귀한다.
2. **Given** 대상 OS가 macOS로 설정된 상태,
   **When** 사용자가 `가나다`를 전송하면,
   **Then** Right Command 키(0xE7)로 한영 전환 후 동일한 결과가 나온다.
3. **Given** BLE 연결 상태,
   **When** `Hello 안녕 World 세계`처럼 한영 혼합 텍스트를 전송하면,
   **Then** 영문 → 한영전환 → 한글 → 한영전환 → 영문 → ... 순서로 자동
   전환되며, PC에서 원문과 동일한 텍스트가 재현된다.
4. **Given** BLE 연결 상태,
   **When** 쌍자음(ㄲ, ㄸ), 복합모음(ㅘ, ㅙ), 겹받침(ㄳ, ㄺ)이 포함된
   텍스트 `왂뷁쁢`를 전송하면,
   **Then** 각 음절이 정확히 분해되어 올바른 키코드로 변환되고
   PC에서 원래 한글이 재현된다.

---

### User Story 4 - 전송 설정 및 OS 선택 (Priority: P4)

사용자는 대상 PC의 운영체제(Windows/macOS)를 선택하고, 타이핑 속도를
조절할 수 있다. 설정은 앱에 저장되어 다음 실행 시에도 유지된다.

**Why this priority**: 다양한 PC 환경에 대응하고, 전송 안정성과 속도 간의
균형을 사용자가 제어할 수 있게 한다. 핵심 전송 기능이 동작한 후 사용성을
향상시키는 역할.

**Independent Test**: 설정 화면에서 OS를 Windows로, 속도를 "빠름"으로
변경한 후 앱을 종료했다가 다시 열면 설정이 유지되어 있다.

**Acceptance Scenarios**:

1. **Given** 설정 화면,
   **When** 대상 OS를 "Windows"에서 "macOS"로 변경하면,
   **Then** 한글 전송 시 사용되는 한영 전환키가 0x90에서 0xE7로 변경된다.
2. **Given** 설정 화면,
   **When** 타이핑 속도를 "안전(10ms)" / "보통(5ms)" / "최대(1ms)" 중
   선택하면,
   **Then** 다음 전송부터 선택된 간격으로 키 입력이 주입된다.
3. **Given** 설정을 변경한 후 앱을 완전히 종료,
   **When** 앱을 다시 실행하면,
   **Then** 이전에 저장한 설정이 그대로 유지된다.

---

### User Story 5 - 전송 안정성 및 오류 복구 (Priority: P5)

대용량 텍스트(수천 자) 전송 시에도 데이터가 손실되지 않으며, BLE 연결 불안정
또는 예기치 못한 상황에서도 키보드가 비정상 상태에 빠지지 않는다.

전송 중 폰이 응답하지 않으면 키보드가 자동으로 타임아웃하여 정상 상태로
복귀한다. 앱은 일시적 오류 시 자동 재전송을 시도한다.

**Why this priority**: 프로덕션 환경에서의 신뢰성 보장. 소스 코드 전송에서
한 글자라도 틀리면 컴파일 오류나 버그로 이어질 수 있다.

**Independent Test**: 5,000자의 소스 코드를 전송하고, PC에서 수신된 텍스트와
원본을 비교하여 100% 일치하는지 확인한다.

**Acceptance Scenarios**:

1. **Given** BLE 연결 상태,
   **When** 5,000자의 소스 코드를 전송하면,
   **Then** PC에서 수신된 텍스트가 원본과 100% 일치한다.
2. **Given** 전송 중 BLE 신호가 일시적으로 약해져 ACK가 지연되는 상황,
   **When** 앱이 ACK 타임아웃을 감지하면,
   **Then** 해당 청크를 자동으로 재전송하고(최대 3회), 성공 시 전송을
   이어간다.
3. **Given** 전송 중 BLE 연결이 완전히 끊어진 상태,
   **When** 키보드가 연결 끊김을 감지하면,
   **Then** 진행 중인 HID 주입을 즉시 중단하고, 모든 눌린 키를 해제하며,
   정상 키보드 상태로 복귀한다.
4. **Given** 전송 시작 후 폰이 30초간 다음 청크를 보내지 않는 상태,
   **When** 키보드의 30초 타임아웃이 만료되면,
   **Then** 키보드가 자동으로 전송을 중단하고 대기 상태로 복귀한다.
5. **Given** 키보드가 USB 모드에서 BLE/2.4GHz 모드로 전환된 상태,
   **When** 모드 전환이 감지되면,
   **Then** TextBridge가 즉시 비활성화되고, BLE 광고를 중지하며,
   진행 중인 전송이 있었다면 중단한다.

---

### Edge Cases

- 전송할 텍스트에 변환 불가능한 문자(이모지, CJK 한자, 특수 유니코드)가
  포함된 경우 해당 문자를 건너뛰고 나머지를 전송하며, 사용자에게
  변환 불가 문자 수를 알려준다.
- 전송 중 사용자가 키보드를 직접 누르면 해당 입력은 차단(무시)되며,
  전송 완료 후 키보드가 정상 동작으로 복귀한다.
- 전송 중단(BLE 끊김, 재전송 3회 실패) 후 재연결 시 이어보내기(resume)는
  지원하지 않으며, 전체 텍스트를 처음부터 다시 전송해야 한다.
  앱은 마지막 전송 실패 위치를 표시하여 사용자가 수동으로 텍스트를
  편집(이미 전송된 부분 삭제)할 수 있도록 돕는다.
- 빈 텍스트로 전송을 시도하면 "전송할 텍스트가 없습니다" 오류를 표시한다.
- BLE 권한이 거부된 상태에서 스캔을 시도하면 권한 요청 안내를 표시한다.
- 이미 본딩된 폰이 있는 상태에서 새 폰으로 페어링을 시도하면(Fn+1 홀드),
  기존 본딩을 교체하고 새 폰과 본딩한다.
- 한글-영문 전환이 빈번한 텍스트(예: `변수a = 값b`)에서 한영 전환키가
  최소 횟수로 삽입되도록 연속 구간을 병합한다.
- PC의 한/영 상태는 원격으로 감지할 수 없으므로, 사용자가 전송 전
  PC를 영문 모드로 설정해야 한다. 이 전제 조건은 사용자 매뉴얼에 명시한다.
  한글 구간 진입 시 한영키 1회로 전환하며, PC가 영문 상태임을 가정한다.

## Requirements *(mandatory)*

### Functional Requirements

**BLE 연결 관리**

- **FR-001**: 키보드 펌웨어는 USB 모드 부팅 시 BLE 스택을 자동으로
  초기화하고 본딩된 기기 전용으로 광고를 시작해야 한다.
- **FR-002**: 최초 페어링은 반드시 물리적 키 조작(Fn+1, 3초 이상 홀드)을
  통해서만 가능해야 한다.
- **FR-003**: 본딩되지 않은 기기의 연결 시도는 반드시 거부해야 한다
  (Filter Accept List).
- **FR-004**: TextBridge BLE 연결은 키보드의 기존 BLE 프로필과 독립된
  별도의 Identity(ID 0)를 사용해야 한다.
- **FR-005**: 앱은 TextBridge 전용 서비스 UUID로 BLE 장치를 필터링하여
  스캔해야 한다.

**텍스트 전송 (ASCII)**

- **FR-006**: 앱은 입력된 텍스트를 (keycode, modifier) 쌍으로 변환해야 한다.
  펌웨어는 키코드 쌍만 수신하여 HID press/release 시퀀스를 실행한다.
- **FR-007**: 전송은 청크 단위로 이루어지며, 각 청크에 대해 키보드가 ACK를
  보낸 후에 다음 청크를 전송해야 한다(한 번에 미확인 청크 최대 1개).
- **FR-008**: 시퀀스 번호(0-255 순환)를 통해 중복 청크를 감지하고,
  이미 처리된 청크의 재수신 시 HID 주입을 건너뛰고 ACK만 재전송해야 한다.
- **FR-009**: 전송 프로토콜은 START → KEYCODE(반복) → DONE 순서를
  준수해야 하며, START 수신 전 KEYCODE를 보내면 오류로 처리해야 한다.
- **FR-010**: 전송 중 사용자가 중지를 요청하면 ABORT 명령을 보내고,
  키보드는 즉시 모든 키를 해제하고 대기 상태로 복귀해야 한다.

**한글 지원**

- **FR-011**: 앱은 유니코드 한글 음절(가-힣, 11,172자)을 초성/중성/종성으로
  분해하고, 두벌식 키보드 배열에 맞는 키코드로 변환해야 한다.
- **FR-012**: 쌍자음(ㄲ, ㄸ, ㅃ, ㅆ, ㅉ)은 Shift modifier를 사용하여
  변환해야 한다.
- **FR-013**: 복합모음(ㅘ, ㅙ, ㅚ, ㅝ, ㅞ, ㅟ, ㅢ)과
  겹받침(ㄳ, ㄵ, ㄶ, ㄺ, ㄻ, ㄼ, ㄽ, ㄾ, ㄿ, ㅀ, ㅄ)은
  2개 이상의 키코드로 확장해야 한다.
- **FR-014**: 한글-영문 전환 시 대상 OS에 맞는 한영 전환키를 자동으로
  삽입해야 한다 (Windows: 0x90/Lang1, macOS: 0xE7/Right GUI).
- **FR-015**: 한글과 영문이 혼합된 텍스트에서 동일 언어 연속 구간을 병합하여
  한영 전환 횟수를 최소화해야 한다.

**설정 및 UI**

- **FR-016**: 앱은 대상 OS(Windows/macOS) 선택을 제공해야 하며,
  선택에 따라 한영 전환키가 달라져야 한다.
- **FR-017**: 앱은 타이핑 속도를 안전(10ms), 보통(5ms), 최대(1ms) 중
  선택할 수 있어야 한다.
- **FR-018**: 사용자 설정(OS, 속도)은 앱 종료 후에도 유지되어야 한다.
- **FR-019**: 앱은 전송 진행률(현재 청크/전체 청크), 전체 문자 수,
  예상 소요 시간을 표시해야 한다.
- **FR-020**: 앱은 변환 불가능한 문자 수를 전송 전에 사용자에게 알려야 한다.

**안정성 및 안전**

- **FR-021**: 키보드 펌웨어는 전송 중 30초간 폰으로부터 응답이 없으면
  자동으로 전송을 중단하고 대기 상태로 복귀해야 한다.
- **FR-022**: BLE 연결 끊김 시 키보드는 즉시 모든 HID 키를 해제하고
  전송 상태를 초기화해야 한다.
- **FR-023**: USB 모드에서 BLE/2.4GHz 모드로 전환되면 TextBridge는 즉시
  비활성화(BLE 광고 중지, 연결 종료, 전송 중단)되어야 한다.
- **FR-024**: 전송 중 사용자의 직접 키보드 입력은 차단(무시)하고, 전송
  완료 후 정상 동작으로 복귀해야 한다.
- **FR-025**: 앱은 ACK를 500ms 동안 대기하고, 타임아웃 시 동일 청크를
  최대 3회까지 자동으로 재전송해야 한다. 3회 실패 시 전송을 중단하고
  사용자에게 오류를 알린다.

### Key Entities

- **키코드 쌍 (Keycode Pair)**: HID keycode(1바이트)와 modifier(1바이트)로
  구성된 단일 키 입력 단위. 앱이 문자를 분석하여 생성하고, 펌웨어가
  press/release로 변환한다.
- **청크 (Chunk)**: 하나의 BLE Write 패킷에 담기는 키코드 쌍의 묶음.
  BLE MTU에 따라 8~119쌍이 포함되며, 시퀀스 번호로 식별된다.
- **전송 세션 (Transmission Session)**: START 명령부터 DONE/ABORT까지의
  하나의 전송 단위. 시퀀스 번호가 0부터 시작하며, 세션 내에서 순차 증가한다.
- **BLE 본딩 (BLE Bond)**: 키보드와 폰 사이의 암호화된 영구 연결 정보.
  최초 페어링 시 생성되며, 이후 자동 연결에 사용된다.
- **한글 음절 (Hangul Syllable)**: 유니코드 0xAC00~0xD7A3 범위의 완성형
  한글. 초성(19) + 중성(21) + 종성(28, 없음 포함) 조합으로 분해되어
  두벌식 키코드로 변환된다.

## Assumptions

- PC의 키보드 레이아웃은 US ANSI (QWERTY)이다.
- 한글 전송 시 PC에 한글 IME가 설치되어 있고, 두벌식 키보드 배열로
  설정되어 있다.
- PC의 초기 입력 상태는 영문(English) 모드이다. 사용자가 전송 전
  영문 모드를 확인해야 하며, 이는 사용자 매뉴얼에 명시한다. 한글 전송 시
  한영키 1회로 한글 모드 전환 후, 전송 완료 시 한영키 1회로 영문 복귀한다.
- BLE MTU 협상은 운영체제(iOS/Android)에 의해 자동으로 처리되며,
  앱이 협상된 MTU 값을 읽어 청크 크기를 결정한다.
- 키보드의 USB 연결은 안정적이며 1000Hz 폴링을 지원한다.
- 한 번에 하나의 폰만 키보드에 연결된다 (멀티 연결 미지원).

## Clarifications

### Session 2026-02-08

- Q: 한/영 상태 동기화 전략 — PC의 현재 한/영 상태를 알 수 없을 때 어떻게 처리하는가? → A: PC가 영문 모드인 상태에서 전송을 시작하는 것을 전제로 한다. 이 전제 조건을 사용자 매뉴얼에 명시하고, 한글 구간 진입/복귀 시 한영키 1회 토글로 처리한다.
- Q: 앱의 ACK 타임아웃 시간 — 앱이 키보드의 ACK를 얼마나 기다린 후 재전송하는가? → A: 500ms. BLE 환경에서 빠른 반응을 우선한다.
- Q: 전송 실패 후 이어보내기(resume) 지원 여부 → A: 미지원. 처음부터 재전송한다. 앱이 실패 위치를 표시하여 수동 편집을 돕는다.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 사용자가 폰에서 1,000자의 영문 소스 코드를 전송하면 10초 이내에
  PC에 100% 정확하게 타이핑된다 (보통 속도 5ms 기준).
- **SC-002**: 사용자가 100자의 한글+영문 혼합 텍스트를 전송하면 PC에서
  원문과 100% 일치하는 텍스트가 재현된다.
- **SC-003**: 5,000자 이상의 대용량 텍스트를 5회 연속 전송했을 때
  전송 실패(데이터 불일치 또는 중단)가 0건이다.
- **SC-004**: 최초 페어링부터 첫 텍스트 전송 완료까지 2분 이내에 달성
  가능하다 (신규 사용자 기준).
- **SC-005**: BLE 연결 끊김 후 키보드가 정상 타이핑 상태로 복귀하는 데
  1초 이내여야 한다.
- **SC-006**: 한글이 포함된 텍스트 전송 시 한영 전환 오류(한글이 영문으로
  또는 영문이 한글로 잘못 입력되는 경우)가 0건이다.
- **SC-007**: 전송 중 30초 타임아웃 및 ABORT 명령 후 키보드에 잔존하는
  눌린 키(stuck key)가 0개여야 한다.
